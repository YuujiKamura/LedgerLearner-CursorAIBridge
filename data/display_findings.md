# チャット表示の問題と解決策

## 問題点の整理

### 1. 質問表示の問題
- **コンテキスト情報表示**: 質問テキストに含まれるJSON形式の`#context:`部分が表示されていた
- **質問文の欠落**: コンテキスト情報を含む部分が表示されると、実際の質問部分が押し出されて見えづらくなる
- **表示形式の不足**: 質問IDやタイムスタンプなどの重要なメタデータが表示されていなかった

### 2. 構造的な問題
- **データの不一致**: `id`と`questionId`のフィールド名が混在していた
- **時間表記の問題**: 未来の日時が使われていた
- **ステータス表記の不一致**: `answered`と`completed`両方使われていた

## 実施した修正

### 1. チャット履歴表示の改善
- **コンテキスト情報の除去**: 正規表現を使ってコンテキスト情報を表示から削除するコードを追加
  ```javascript
  displayQuestion = displayQuestion.replace(/#context:.*?(\n|\r|$)/g, '');
  ```
- **メタデータ表示の追加**: 質問ID、投稿時間、回答ステータスが表示されるようにした
  ```javascript
  const metaInfo = document.createElement('div');
  metaInfo.className = 'chat-meta-info';
  // 質問ID、時間、ステータスの表示
  ```
- **回答メタデータの追加**: 回答時間を表示するコードを追加
  ```javascript
  const answerMeta = document.createElement('div');
  answerMeta.className = 'answer-meta-info';
  // 回答時間の表示
  ```

### 2. データ構造の整理
- **chat_history_validator.js**: データ検証と修正するユーティリティを作成
  - `id`と`questionId`の統一
  - 未来の日時の修正
  - ステータスの統一

### 3. UIデザインの改善
- **CSS追加**: メタデータ表示のためのスタイル定義を追加
  ```css
  .chat-meta-info {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 5px;
      color: #7f8c8d;
      font-size: 0.85em;
  }
  ```

## 自動テスト
テスト用のスクリプト`tests/display_validator.js`を作成し、以下のテストを行えるようにしました：

1. **ページ読み込みテスト**: サーバーが正常に応答し、ページが読み込めるか
2. **履歴タブ表示テスト**: 履歴タブが正常に表示されるか
3. **チャット履歴アイテム表示テスト**: チャット履歴のアイテムが表示されるか
4. **コンテキスト情報処理テスト**: コンテキスト情報が正しく除去されているか
5. **メタデータ表示テスト**: 質問ID、投稿時間、回答ステータスなどが表示されているか

## 今後の課題
1. **サーバー再起動対応**: サーバー再起動時にクライアント側のデータが正しく同期されるようにする
2. **データ整合性チェック強化**: chat_historyとanswer_dataの間の整合性を確保する
3. **エラーハンドリング**: JSONやデータ形式の問題に対するより強固なエラーハンドリング
4. **表示のカスタマイズ**: ユーザーがメタデータ表示をカスタマイズできるようにする 